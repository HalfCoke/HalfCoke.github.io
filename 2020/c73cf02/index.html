<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Flink Metrics REST API使用 | CCCCCoke</title><meta name="keywords" content="Flink,流处理,metrics"><meta name="author" content="HalfCoke"><meta name="copyright" content="HalfCoke"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Flink Metrics REST API使用Operator Metrics采集 idletime numRecords queueLen  https:&#x2F;&#x2F;ci.apache.org&#x2F;projects&#x2F;flink&#x2F;flink-docs-release-1.12&#x2F;ops&#x2F;metrics.html#default-shuffle-service TaskManager Metrics采集Flin">
<meta property="og:type" content="article">
<meta property="og:title" content="Flink Metrics REST API使用">
<meta property="og:url" content="https://halfcoke.github.io/2020/c73cf02/index.html">
<meta property="og:site_name" content="CCCCCoke">
<meta property="og:description" content="Flink Metrics REST API使用Operator Metrics采集 idletime numRecords queueLen  https:&#x2F;&#x2F;ci.apache.org&#x2F;projects&#x2F;flink&#x2F;flink-docs-release-1.12&#x2F;ops&#x2F;metrics.html#default-shuffle-service TaskManager Metrics采集Flin">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310130905.png">
<meta property="article:published_time" content="2020-12-23T07:10:30.000Z">
<meta property="article:modified_time" content="2024-11-08T17:41:15.694Z">
<meta property="article:author" content="HalfCoke">
<meta property="article:tag" content="Flink">
<meta property="article:tag" content="流处理">
<meta property="article:tag" content="metrics">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310130905.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://halfcoke.github.io/2020/c73cf02/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'pub-6942839821989447',
  enable_page_level_ads: 'true'
});</script><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Flink Metrics REST API使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-09 01:41:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/v2-bd05131cd8bea6dc03a408183fc37d22_b.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">CCCCCoke</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">Flink Metrics REST API使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-23T07:10:30.000Z" title="发表于 2020-12-23 15:10:30">2020-12-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-08T17:41:15.694Z" title="更新于 2024-11-09 01:41:15">2024-11-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%B5%81%E5%A4%84%E7%90%86/">流处理</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/%E6%B5%81%E5%A4%84%E7%90%86/Flink/">Flink</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Flink Metrics REST API使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h1 id="Flink-Metrics-REST-API使用"><a href="#Flink-Metrics-REST-API使用" class="headerlink" title="Flink Metrics REST API使用"></a>Flink Metrics REST API使用</h1><h2 id="Operator-Metrics采集"><a href="#Operator-Metrics采集" class="headerlink" title="Operator Metrics采集"></a>Operator Metrics采集</h2><ul>
<li>idletime</li>
<li>numRecords</li>
<li>queueLen</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html#default-shuffle-service">https://ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html#default-shuffle-service</a></p>
<h2 id="TaskManager-Metrics采集"><a href="#TaskManager-Metrics采集" class="headerlink" title="TaskManager Metrics采集"></a>TaskManager Metrics采集</h2><p>Flink基于JVM运行，对TM Metrics的分析实际上就是在进程及线程级别进行分析。</p>
<p>Flink采集TM的JVM指标时，是通过java自己的<code>OperatingSystemMXBean</code>来进行采集的，具体如下：</p>
<h4 id="JVM-CPU负载情况"><a href="#JVM-CPU负载情况" class="headerlink" title="JVM CPU负载情况"></a>JVM CPU负载情况</h4><p>Flink部分源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/MetricUtils.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">instantiateCPUMetrics</span><span class="params">(MetricGroup metrics)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> com.sun.management.<span class="type">OperatingSystemMXBean</span> <span class="variable">mxBean</span> <span class="operator">=</span> (com.sun.management.OperatingSystemMXBean) ManagementFactory.getOperatingSystemMXBean();</span><br><span class="line"></span><br><span class="line">        metrics.&lt;Double, Gauge&lt;Double&gt;&gt;gauge(<span class="string">&quot;Load&quot;</span>, mxBean::getProcessCpuLoad);</span><br><span class="line">        metrics.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;Time&quot;</span>, mxBean::getProcessCpuTime);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Cannot access com.sun.management.OperatingSystemMXBean.getProcessCpuLoad()&quot;</span> +</span><br><span class="line">                 <span class="string">&quot; - CPU load metrics will not be available.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>jvm提供的<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getProcessCpuLoad()"><code>getProcessCpuLoad()</code>方法</a>，介绍如下</p>
<blockquote>
<p>返回Java虚拟机进程的“最近cpu使用量”。该值是[0.0,1.0]区间内的一个双精度值。0.0的值表示在最近观察的时间段内没有一个cpu运行来自JVM进程的线程，而1.0的值表示在最近观察的时间段内，所有cpu 100%都在活跃地运行来自JVM进程的线程。来自JVM的线程包括应用程序线程和JVM内部线程。根据JVM进程和整个系统中正在进行的活动，0.0到1.0之间的所有值都是可能的。如果Java虚拟机最近的CPU占用率不可用，该方法返回一个负数。</p>
<p>Returns the “recent cpu usage” for the Java Virtual Machine process. This value is a double in the [0.0,1.0] interval. A value of 0.0 means that none of the CPUs were running threads from the JVM process during the recent period of time observed, while a value of 1.0 means that all CPUs were actively running threads from the JVM 100% of the time during the recent period being observed. Threads from the JVM include the application threads as well as the JVM internal threads. All values betweens 0.0 and 1.0 are possible depending of the activities going on in the JVM process and the whole system. If the Java Virtual Machine recent CPU usage is not available, the method returns a negative value.</p>
</blockquote>
<p>该方法返回整个JVM的CPU使用情况，要想获得进程级别的需要考虑其他方法。</p>
<ul>
<li>可以通过jps获得TaskManager的进程ID</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131222.png" alt="image-20201224222950624"></p>
<ul>
<li>然后根据进程ID通过<code>top -H -p 23621</code>可以看到线程对CPU的使用情况，这里可以看到每一个算子都是一个线程，但是使用程序导出时应考虑一下其他命令</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131259.png" alt="image-20201224222919852"></p>
<h4 id="JVM-内存使用情况"><a href="#JVM-内存使用情况" class="headerlink" title="JVM 内存使用情况"></a>JVM 内存使用情况</h4><h5 id="JVM-内存类型"><a href="#JVM-内存类型" class="headerlink" title="JVM 内存类型"></a>JVM 内存类型</h5><blockquote>
<p>参考<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/lang/management/MemoryMXBean.html">https://docs.oracle.com/javase/8/docs/api/java/lang/management/MemoryMXBean.html</a></p>
</blockquote>
<ol>
<li><p>Heap</p>
<blockquote>
<p>Java虚拟机有一个堆，它是运行时数据区域，所有类实例和数组的内存都从这个堆中分配。它在Java虚拟机启动时创建。对象的堆内存由被称为垃圾收集器的自动内存管理系统回收。</p>
<p>堆的大小可以固定，也可以扩展或收缩。堆的内存不需要是连续的。</p>
<p>The Java virtual machine has a <em>heap</em> that is the runtime data area from which memory for all class instances and arrays are allocated. It is created at the Java virtual machine start-up. Heap memory for objects is reclaimed by an automatic memory management system which is known as a <em>garbage collector</em>.</p>
<p>The heap may be of a fixed size or may be expanded and shrunk. The memory for the heap does not need to be contiguous.</p>
</blockquote>
</li>
<li><p>Non-Heap</p>
<blockquote>
<p>Java虚拟机管理堆以外的内存(称为非堆内存)。</p>
<p>Java虚拟机有一个在所有线程之间共享的方法区域。方法区域属于非堆内存。它存储每个类的结构，比如运行时常量池、字段和方法数据，以及方法和构造函数的代码。它在Java虚拟机启动时创建。</p>
<p>方法区域在逻辑上是堆的一部分，但是Java虚拟机实现可以选择不进行垃圾收集或压缩它。与堆类似，方法区域可以是固定大小的，也可以扩展或收缩。方法区域的内存不需要是连续的。</p>
<p>除了方法区域，Java虚拟机实现可能需要内存用于内部处理或优化，这些内存也属于非堆内存。例如，JIT编译器需要内存来存储从Java虚拟机代码转换过来的本机机器代码，以获得高性能。</p>
<p>The Java virtual machine manages memory other than the heap (referred as <em>non-heap memory</em>).</p>
<p>The Java virtual machine has a <em>method area</em> that is shared among all threads. The method area belongs to non-heap memory. It stores per-class structures such as a runtime constant pool, field and method data, and the code for methods and constructors. It is created at the Java virtual machine start-up.</p>
<p>The method area is logically part of the heap but a Java virtual machine implementation may choose not to either garbage collect or compact it. Similar to the heap, the method area may be of a fixed size or may be expanded and shrunk. The memory for the method area does not need to be contiguous.</p>
<p>In addition to the method area, a Java virtual machine implementation may require memory for internal processing or optimization which also belongs to non-heap memory. For example, the JIT compiler requires memory for storing the native machine code translated from the Java virtual machine code for high performance.</p>
</blockquote>
</li>
</ol>
<h5 id="MemoryUsage"><a href="#MemoryUsage" class="headerlink" title="MemoryUsage"></a>MemoryUsage</h5><p>MemoryUsage对象包含四部分</p>
<ul>
<li><p>init</p>
<p>表示Java虚拟机在启动期间从操作系统请求内存管理的初始内存量(以字节为单位)。Java虚拟机可能会向操作系统请求额外的内存，也可能会随着时间的推移向系统释放内存。init的值可能是未定义的。</p>
</li>
<li><p>used</p>
<p>当前正在使用的内存量，字节数</p>
</li>
<li><p>committed</p>
<p>表示保证可由Java虚拟机使用的内存量(以字节为单位)。提交的内存数量可能会随时间变化(增加或减少)。Java虚拟机可能释放内存给系统，提交的内存可能小于init。committed总是大于或等于used。</p>
</li>
<li><p>max</p>
<p>表示可用于内存管理的最大内存量(以字节为单位)。它的值可能没有定义。如果定义了最大内存量，则可能随时间而改变。如果定义了max，则已使用和提交的内存总量将始终小于或等于max。如果试图增加已用内存使其大于提交内存，这样即使used &lt;&#x3D; max仍然为true(例如，当系统的虚拟内存不足时)，那么内存分配可能会失败。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131803.png" alt="image-20201228104216053"></p>
<p>对jvm内存的事情情况通过 OpenJDK管理工具获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/MetricUtils.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">instantiateMemoryUsageMetrics</span><span class="params">(<span class="keyword">final</span> MetricGroup metricGroup, <span class="keyword">final</span> Supplier&lt;MemoryUsage&gt; memoryUsageSupplier)</span> &#123;</span><br><span class="line">    metricGroup.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(MetricNames.MEMORY_USED, () -&gt; memoryUsageSupplier.get().getUsed());</span><br><span class="line">    metricGroup.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(MetricNames.MEMORY_COMMITTED, () -&gt; memoryUsageSupplier.get().getCommitted());</span><br><span class="line">    metricGroup.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(MetricNames.MEMORY_MAX, () -&gt; memoryUsageSupplier.get().getMax());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em><strong>关于堆内存、非堆内存等内存类型参考JVM虚拟机相关内容</strong></em></p>
<p>Status.Flink.Memory是<a target="_blank" rel="noopener" href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-102%3A+Add+More+Metrics+to+TaskManager">Flink1.12.0</a>新增加的<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/FLINK-14406">特性</a></p>
<p>在获取Flink已用的内存大小时，是依次获得每个Slot所用的内存。</p>
<p>获得总计的Flink管理内存时，是直接获取配置文件中的<code>taskmanager.memory.managed.size</code></p>
<blockquote>
<p>TaskExecutor管理内存大小，是由memory manager管理的非堆内存大小，为排序、哈希表、中间结果缓存、RocksDB状态后端所保留的大小。</p>
<p>内存使用者可以从内存管理器中以MemorySegments的形式分配内存，也可以从内存管理器中保留字节，并将其内存使用保持在该边界内。如果未指定，则派生它，以构成总Flink内存的配置部分。</p>
<p>Managed Memory size for TaskExecutors. This is the size of off-heap memory managed by the memory manager, reserved for sorting, hash tables, caching of intermediate results and RocksDB state backend. Memory consumers can either allocate memory from the memory manager in the form of MemorySegments, or reserve bytes from the memory manager and keep their memory usage within that boundary. If unspecified, it will be derived to make up the configured fraction of the Total Flink Memory.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/MetricUtils.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">getUsedManagedMemory</span><span class="params">(TaskSlotTable&lt;?&gt; taskSlotTable)</span> &#123;</span><br><span class="line">    Set&lt;AllocationID&gt; activeTaskAllocationIds = taskSlotTable.getActiveTaskSlotAllocationIds();</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">usedMemory</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">for</span> (AllocationID allocationID : activeTaskAllocationIds) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MemoryManager</span> <span class="variable">taskSlotMemoryManager</span> <span class="operator">=</span> taskSlotTable.getTaskMemoryManager(allocationID);</span><br><span class="line">            usedMemory += taskSlotMemoryManager.getMemorySize() - taskSlotMemoryManager.availableMemory();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SlotNotFoundException e) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;The task slot &#123;&#125; is not present anymore and will be ignored in calculating the amount of used memory.&quot;</span>, allocationID);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> usedMemory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="JVM垃圾回收情况"><a href="#JVM垃圾回收情况" class="headerlink" title="JVM垃圾回收情况"></a>JVM垃圾回收情况</h4><p>垃圾回收可以获得回收的次数以及总时间，其中<GarbageCollector>的名字是通过Jvm管理工具的如下方法获得的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GarbageCollectorMXBean::getName</span><br></pre></td></tr></table></figure>

<h4 id="TM网络情况"><a href="#TM网络情况" class="headerlink" title="TM网络情况"></a>TM网络情况</h4><p>这里会采集TM所用的网络内存的相关信息<a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html#default-shuffle-service">https://ci.apache.org/projects/flink/flink-docs-release-1.12/ops/metrics.html#default-shuffle-service</a></p>
<p>通过下面的Flink源码增加了相关的Metrics</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/io/network/metrics/NettyShuffleMetricFactory.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">internalRegisterShuffleMetrics</span><span class="params">(</span></span><br><span class="line"><span class="params">    MetricGroup parentMetricGroup,</span></span><br><span class="line"><span class="params">    NetworkBufferPool networkBufferPool)</span> &#123;</span><br><span class="line">    <span class="type">MetricGroup</span> <span class="variable">shuffleGroup</span> <span class="operator">=</span> parentMetricGroup.addGroup(METRIC_GROUP_SHUFFLE);</span><br><span class="line">    <span class="type">MetricGroup</span> <span class="variable">networkGroup</span> <span class="operator">=</span> shuffleGroup.addGroup(METRIC_GROUP_NETTY);</span><br><span class="line"></span><br><span class="line">    networkGroup.gauge(METRIC_TOTAL_MEMORY_SEGMENT,</span><br><span class="line">                       networkBufferPool::getTotalNumberOfMemorySegments);</span><br><span class="line">    networkGroup.gauge(METRIC_TOTAL_MEMORY,</span><br><span class="line">                       networkBufferPool::getTotalMemory);</span><br><span class="line"></span><br><span class="line">    networkGroup.gauge(METRIC_AVAILABLE_MEMORY_SEGMENT,</span><br><span class="line">                       networkBufferPool::getNumberOfAvailableMemorySegments);</span><br><span class="line">    networkGroup.gauge(METRIC_AVAILABLE_MEMORY,</span><br><span class="line">                       networkBufferPool::getAvailableMemory);</span><br><span class="line"></span><br><span class="line">    networkGroup.gauge(METRIC_USED_MEMORY_SEGMENT,</span><br><span class="line">                       networkBufferPool::getNumberOfUsedMemorySegments);</span><br><span class="line">    networkGroup.gauge(METRIC_USED_MEMORY,</span><br><span class="line">                       networkBufferPool::getUsedMemory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getTotalNumberOfMemorySegments</code>与<a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/deployment/config.html#taskmanager-memory-network-min"><code>taskmanager.memory.network.min</code></a>配置项相关</p>
<blockquote>
<p>TaskExecutors的最小网络内存大小。网络内存是为ShuffleEnvironment预留的堆外内存(例如，网络缓冲区)。网络内存大小是由总链接内存的配置部分组成的。如果导出的大小小于&#x2F;大于配置的最小&#x2F;最大大小，则使用最小&#x2F;最大大小。网络内存的确切大小可以通过设置相同的最小&#x2F;最大值来显式指定</p>
<p>Min Network Memory size for TaskExecutors. Network Memory is off-heap memory reserved for ShuffleEnvironment (e.g., network buffers). Network Memory size is derived to make up the configured fraction of the Total Flink Memory. If the derived size is less&#x2F;greater than the configured min&#x2F;max size, the min&#x2F;max size will be used. The exact size of Network Memory can be explicitly specified by setting the min&#x2F;max to the same value.</p>
</blockquote>
<h4 id="Metrics-列表"><a href="#Metrics-列表" class="headerlink" title="Metrics 列表"></a>Metrics 列表</h4><h5 id="JVM-CPU指标"><a href="#JVM-CPU指标" class="headerlink" title="JVM CPU指标"></a>JVM CPU指标</h5><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">Status.JVM.CPU</td>
<td align="left">Load</td>
<td align="left">The recent CPU usage of the JVM.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Time</td>
<td align="left">The CPU time used by the JVM.</td>
<td align="left">Gauge</td>
</tr>
</tbody></table>
<h5 id="JVM-Memory"><a href="#JVM-Memory" class="headerlink" title="JVM Memory"></a>JVM Memory</h5><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">Status.JVM.Memory</td>
<td align="left">Heap.Used</td>
<td align="left">The amount of heap memory currently used (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Heap.Committed</td>
<td align="left">The amount of heap memory guaranteed to be available to the JVM (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Heap.Max</td>
<td align="left">The maximum amount of heap memory that can be used for memory management (in bytes). This value might not be necessarily equal to the maximum value specified through -Xmx or the equivalent Flink configuration parameter. Some GC algorithms allocate heap memory that won’t be available to the user code and, therefore, not being exposed through the heap metrics.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">NonHeap.Used</td>
<td align="left">The amount of non-heap memory currently used (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">NonHeap.Committed</td>
<td align="left">The amount of non-heap memory guaranteed to be available to the JVM (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">NonHeap.Max</td>
<td align="left">The maximum amount of non-heap memory that can be used for memory management (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Metaspace.Used</td>
<td align="left">The amount of memory currently used in the Metaspace memory pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Metaspace.Committed</td>
<td align="left">The amount of memory guaranteed to be available to the JVM in the Metaspace memory pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Metaspace.Max</td>
<td align="left">The maximum amount of memory that can be used in the Metaspace memory pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Direct.Count</td>
<td align="left">The number of buffers in the direct buffer pool.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Direct.MemoryUsed</td>
<td align="left">The amount of memory used by the JVM for the direct buffer pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Direct.TotalCapacity</td>
<td align="left">The total capacity of all buffers in the direct buffer pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Mapped.Count</td>
<td align="left">The number of buffers in the mapped buffer pool.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Mapped.MemoryUsed</td>
<td align="left">The amount of memory used by the JVM for the mapped buffer pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Mapped.TotalCapacity</td>
<td align="left">The number of buffers in the mapped buffer pool (in bytes).</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">Status.Flink.Memory</td>
<td align="left">Managed.Used</td>
<td align="left">The amount of managed memory currently used.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Managed.Total</td>
<td align="left">The total amount of managed memory.</td>
<td align="left">Gauge</td>
</tr>
</tbody></table>
<h5 id="GarbageCollection"><a href="#GarbageCollection" class="headerlink" title="GarbageCollection"></a>GarbageCollection</h5><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
<th align="left">Type</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">Status.JVM.GarbageCollector</td>
<td align="left"><GarbageCollector>.Count</td>
<td align="left">The total number of collections that have occurred.</td>
<td align="left">Gauge</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left"><GarbageCollector>.Time</td>
<td align="left">The total time spent performing garbage collection.</td>
<td align="left">Gauge</td>
</tr>
</tbody></table>
<h4 id="使用RestAPI获取TM-JVM性能指标"><a href="#使用RestAPI获取TM-JVM性能指标" class="headerlink" title="使用RestAPI获取TM JVM性能指标"></a>使用RestAPI获取TM JVM性能指标</h4><h5 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h5><p><code>url</code>: <code>http://&lt;jobmanager&gt;:&lt;port&gt;/taskmanagers/:taskmanagerid/metrics</code></p>
<p><code>params</code>:</p>
<ul>
<li><code>Status.JVM.CPU.Time</code></li>
<li><code>Status.JVM.CPU.Load</code>获取jvm进程的CPU负载，要想获得线程级的需要进一步考虑</li>
</ul>
<h2 id="System-Metrics采集"><a href="#System-Metrics采集" class="headerlink" title="System Metrics采集"></a>System Metrics采集</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><p>Flink使用<code>OSHI</code>来采集系统硬件信息</p>
<h4 id="CPU使用率获取方式"><a href="#CPU使用率获取方式" class="headerlink" title="CPU使用率获取方式"></a>CPU使用率获取方式</h4><p>Flink中关于CPU负载部分的采集源码如下，其中<code>getSystemCpuLoadTicks()</code>方法为<a target="_blank" rel="noopener" href="https://oshi.github.io/oshi/apidocs/oshi/hardware/CentralProcessor.html#getSystemCpuLoadTicks()">OSHI的方法</a>。</p>
<p>该方法返回的指标中，<code>irq</code>为<code>Hardware interrupts</code>，<code>SoftIRQ</code>为<code>Software interrupts</code>。</p>
<p>oshi访问<code>/proc/stat</code>文件获取CPU信息</p>
<p><code>/proc/stat</code>文件部分截图</p>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131765.png" alt="image-20201223170433096"></p>
<p><em><strong>重要</strong></em></p>
<p><code>oshi</code>在对<code>cpuUsage</code>使用的<code>getSystemCpuLoad()</code>方法调用了调用了<code>com.sun.management.OperatingSystemMXBean</code>中的<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/7/docs/jre/api/management/extension/com/sun/management/OperatingSystemMXBean.html#getSystemCpuLoad()"><code>getSystemCpuLoad()</code>方法</a>来获得负载。该方法说明如下：</p>
<blockquote>
<p>返回整个系统的“最近的CPU使用情况”。 此值是[0.0,1.0]区间中的小数。 值0.0表示在最近观察到的时间内所有CPU都处于空闲状态，而值1.0表示在观察到的最近一段时间内所有CPU 100％处于活动状态。 介于0.0到1.0之间的所有值都是可能的，具体取决于系统中正在进行的活动。 如果系统最近的CPU使用率不可用，则该方法返回负值。</p>
<p>Returns the “recent cpu usage” for the whole system. This value is a double in the [0.0,1.0] interval. A value of 0.0 means that all CPUs were idle during the recent period of time observed, while a value of 1.0 means that all CPUs were actively running 100% of the time during the recent period being observed. All values betweens 0.0 and 1.0 are possible depending of the activities going on in the system. If the system recent cpu usage is not available, the method returns a negative value.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/SystemResourcesCounter.java</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">calculateCPUUsage</span><span class="params">(CentralProcessor processor)</span> &#123;</span><br><span class="line">		<span class="type">long</span>[] ticks = processor.getSystemCpuLoadTicks();</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.previousCpuTicks == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.previousCpuTicks = ticks;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 使用两次检测之间的时钟数来计算百分比</span></span><br><span class="line">		<span class="type">long</span> <span class="variable">userTicks</span> <span class="operator">=</span> ticks[TickType.USER.getIndex()] - previousCpuTicks[TickType.USER.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">niceTicks</span> <span class="operator">=</span> ticks[TickType.NICE.getIndex()] - previousCpuTicks[TickType.NICE.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">sysTicks</span> <span class="operator">=</span> ticks[TickType.SYSTEM.getIndex()] - previousCpuTicks[TickType.SYSTEM.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">idleTicks</span> <span class="operator">=</span> ticks[TickType.IDLE.getIndex()] - previousCpuTicks[TickType.IDLE.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">iowaitTicks</span> <span class="operator">=</span> ticks[TickType.IOWAIT.getIndex()] - previousCpuTicks[TickType.IOWAIT.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">irqTicks</span> <span class="operator">=</span> ticks[TickType.IRQ.getIndex()] - previousCpuTicks[TickType.IRQ.getIndex()];</span><br><span class="line">		<span class="type">long</span> <span class="variable">softIrqTicks</span> <span class="operator">=</span> ticks[TickType.SOFTIRQ.getIndex()] - previousCpuTicks[TickType.SOFTIRQ.getIndex()];</span><br><span class="line">        <span class="comment">// 这说明user、nice、sys、idle、iow、irq、softirq之和应为100%。</span></span><br><span class="line">        <span class="comment">// 在flink提供的指标中，放弃了getSystemCpuLoadTicks()方法返回的Steal时间，Steal时间表示有虚拟机的时候，被虚拟机占用的时间</span></span><br><span class="line">		<span class="type">long</span> <span class="variable">totalCpuTicks</span> <span class="operator">=</span> userTicks + niceTicks + sysTicks + idleTicks + iowaitTicks + irqTicks + softIrqTicks;</span><br><span class="line">		<span class="built_in">this</span>.previousCpuTicks = ticks;</span><br><span class="line"></span><br><span class="line">		cpuUser = <span class="number">100d</span> * userTicks / totalCpuTicks;</span><br><span class="line">		cpuNice = <span class="number">100d</span> * niceTicks / totalCpuTicks;</span><br><span class="line">		cpuSys = <span class="number">100d</span> * sysTicks / totalCpuTicks;</span><br><span class="line">		cpuIdle = <span class="number">100d</span> * idleTicks / totalCpuTicks;</span><br><span class="line">		cpuIOWait = <span class="number">100d</span> * iowaitTicks / totalCpuTicks;</span><br><span class="line">		cpuIrq = <span class="number">100d</span> * irqTicks / totalCpuTicks;</span><br><span class="line">		cpuSoftIrq = <span class="number">100d</span> * softIrqTicks / totalCpuTicks;</span><br><span class="line"></span><br><span class="line">		cpuUsage = processor.getSystemCpuLoad() * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">		<span class="type">double</span>[] loadAverage = processor.getSystemLoadAverage(<span class="number">3</span>);</span><br><span class="line">		cpuLoad1 = (loadAverage[<span class="number">0</span>] &lt; <span class="number">0</span> ? Double.NaN : loadAverage[<span class="number">0</span>]);</span><br><span class="line">		cpuLoad5 = (loadAverage[<span class="number">1</span>] &lt; <span class="number">0</span> ? Double.NaN : loadAverage[<span class="number">1</span>]);</span><br><span class="line">		cpuLoad15 = (loadAverage[<span class="number">2</span>] &lt; <span class="number">0</span> ? Double.NaN : loadAverage[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">		<span class="type">double</span>[] load = processor.getProcessorCpuLoadBetweenTicks();</span><br><span class="line">		checkState(load.length == cpuUsagePerProcessor.length());</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; load.length; i++) &#123;</span><br><span class="line">			cpuUsagePerProcessor.set(i, load[i] * <span class="number">100</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<h4 id="内存使用率获取方式"><a href="#内存使用率获取方式" class="headerlink" title="内存使用率获取方式"></a>内存使用率获取方式</h4><p>oshi访问文件<code>/proc/meminfo</code>来获取内存信息</p>
<p><code>/proc/meminfo</code>文件部分截图</p>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131311.png" alt="image-20201223165623999"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/SystemResourcesMetricsInitializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">instantiateMemoryMetrics</span><span class="params">(MetricGroup metrics, GlobalMemory memory)</span> &#123;</span><br><span class="line">    <span class="comment">// 获取Available大小，这与Free不同，Free表示一直没有被使用过的内存，如果有一个程序之前使用了部分内存，现在不用了，Linux也不会将这部分内存算成Free</span></span><br><span class="line">    <span class="comment">// 而Available包含了这部分可以回收的内存，因此Available要大于Free</span></span><br><span class="line">    metrics.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;Available&quot;</span>, memory::getAvailable);</span><br><span class="line">    metrics.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;Total&quot;</span>, memory::getTotal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="swap交换分区使用率获取方式"><a href="#swap交换分区使用率获取方式" class="headerlink" title="swap交换分区使用率获取方式"></a>swap交换分区使用率获取方式</h4><p>oshi访问文件<code>/proc/meminfo</code>来获取内存信息，与获取内存使用相同</p>
<p>这里直接调用<code>oshi</code>的<code>getSwapUsed</code>方法，在<code>oshi</code>中，<code>SwapUsed</code>是通过<code>/proc/meminfo</code>文件中的<code>Total</code>和<code>Free</code>相减得到的。</p>
<p>Swap的使用，能表现出系统内存是否够用，如果频繁使用Swap，则表示<em>系统内存不足</em>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131950.png" alt="image-20201223170913324"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/SystemResourcesMetricsInitializer.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">instantiateSwapMetrics</span><span class="params">(MetricGroup metrics, GlobalMemory memory)</span> &#123;</span><br><span class="line">    metrics.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;Used&quot;</span>, memory::getSwapUsed);</span><br><span class="line">    metrics.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;Total&quot;</span>, memory::getSwapTotal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="网络使用情况获取方式"><a href="#网络使用情况获取方式" class="headerlink" title="网络使用情况获取方式"></a>网络使用情况获取方式</h4><p><code>oshi</code>通过<code>getNetworkIFs()</code>方法获取网络接口列表，包括本地接口。访问以下这些文件获取接口数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// oshi/hardware/platform/linux/LinuxNetworks.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">updateNetworkStats</span><span class="params">(NetworkIF netIF)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">txBytesPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/tx_bytes&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">rxBytesPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/rx_bytes&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">txPacketsPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/tx_packets&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">rxPacketsPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/rx_packets&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">txErrorsPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/tx_errors&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">rxErrorsPath</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/statistics/rx_errors&quot;</span>, netIF.getName());</span><br><span class="line">    <span class="type">String</span> <span class="variable">speed</span> <span class="operator">=</span> String.format(<span class="string">&quot;/sys/class/net/%s/speed&quot;</span>, netIF.getName());</span><br><span class="line"></span><br><span class="line">    netIF.setTimeStamp(System.currentTimeMillis());</span><br><span class="line">    netIF.setBytesSent(FileUtil.getLongFromFile(txBytesPath));</span><br><span class="line">    netIF.setBytesRecv(FileUtil.getLongFromFile(rxBytesPath));</span><br><span class="line">    netIF.setPacketsSent(FileUtil.getLongFromFile(txPacketsPath));</span><br><span class="line">    netIF.setPacketsRecv(FileUtil.getLongFromFile(rxPacketsPath));</span><br><span class="line">    netIF.setOutErrors(FileUtil.getLongFromFile(txErrorsPath));</span><br><span class="line">    netIF.setInErrors(FileUtil.getLongFromFile(rxErrorsPath));</span><br><span class="line">    netIF.setSpeed(FileUtil.getLongFromFile(speed));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Flink中，获得每个接口的发送接收的速率。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org/apache/flink/runtime/metrics/util/SystemResourcesMetricsInitializer.java</span></span><br><span class="line"><span class="comment">// 这里分别获取不同网卡的信息</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">instantiateNetworkMetrics</span><span class="params">(MetricGroup metrics, SystemResourcesCounter usageCounter)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; usageCounter.getNetworkInterfaceNames().length; i++) &#123;</span><br><span class="line">        <span class="type">MetricGroup</span> <span class="variable">interfaceGroup</span> <span class="operator">=</span> metrics.addGroup(usageCounter.getNetworkInterfaceNames()[i]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">interfaceNo</span> <span class="operator">=</span> i;</span><br><span class="line">        interfaceGroup.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;ReceiveRate&quot;</span>, () -&gt; usageCounter.getReceiveRatePerInterface(interfaceNo));</span><br><span class="line">        interfaceGroup.&lt;Long, Gauge&lt;Long&gt;&gt;gauge(<span class="string">&quot;SendRate&quot;</span>, () -&gt; usageCounter.getSendRatePerInterface(interfaceNo));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">calculateNetworkUsage</span><span class="params">(NetworkIF[] networkIFs)</span> &#123;</span><br><span class="line">    checkState(networkIFs.length == receiveRatePerInterface.length());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; networkIFs.length; i++) &#123;</span><br><span class="line">        <span class="type">NetworkIF</span> <span class="variable">networkIF</span> <span class="operator">=</span> networkIFs[i];</span><br><span class="line">        networkIF.updateNetworkStats();</span><br><span class="line"><span class="comment">// 在这里设置每个接口发送接收的速率</span></span><br><span class="line">        receiveRatePerInterface.set(i, (networkIF.getBytesRecv() - bytesReceivedPerInterface[i]) * <span class="number">1000</span> / probeIntervalMs);</span><br><span class="line">        sendRatePerInterface.set(i, (networkIF.getBytesSent() - bytesSentPerInterface[i]) * <span class="number">1000</span> / probeIntervalMs);</span><br><span class="line"></span><br><span class="line">        bytesReceivedPerInterface[i] = networkIF.getBytesRecv();</span><br><span class="line">        bytesSentPerInterface[i] = networkIF.getBytesSent();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置Flink"><a href="#配置Flink" class="headerlink" title="配置Flink"></a>配置Flink</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># FLINK_HOME/lib文件夹下</span></span><br><span class="line">wget https://repo1.maven.org/maven2/com/github/oshi/oshi-core/3.4.0/oshi-core-3.4.0.jar</span><br><span class="line">wget https://repo1.maven.org/maven2/net/java/dev/jna/jna-platform/4.2.2/jna-platform-4.2.2.jar</span><br><span class="line">wget https://repo1.maven.org/maven2/net/java/dev/jna/jna/4.2.2/jna-4.2.2.jar</span><br></pre></td></tr></table></figure>

<h3 id="Metrics列表"><a href="#Metrics列表" class="headerlink" title="Metrics列表"></a>Metrics列表</h3><h4 id="System-CPU"><a href="#System-CPU" class="headerlink" title="System CPU"></a>System CPU</h4><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">System.CPU</td>
<td align="left">Usage</td>
<td align="left">总体CPU使用。Overall % of CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Idle</td>
<td align="left">CPU空闲半分比，% of CPU Idle usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Sys</td>
<td align="left">CPU内核时间占用百分比，% of System CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">User</td>
<td align="left">CPU用户空间占用百分比，% of User CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">IOWait</td>
<td align="left">CPU等待输入输出百分比，% of IOWait CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Irq</td>
<td align="left">% of Irq CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">SoftIrq</td>
<td align="left">% of SoftIrq CPU usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Nice</td>
<td align="left">% of Nice Idle usage on the machine.</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Load1min</td>
<td align="left">Average CPU load over 1 minute</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Load5min</td>
<td align="left">Average CPU load over 5 minute</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Load15min</td>
<td align="left">Average CPU load over 15 minute</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">UsageCPU*</td>
<td align="left">% of CPU usage per each processor</td>
</tr>
</tbody></table>
<h4 id="System-memory"><a href="#System-memory" class="headerlink" title="System memory"></a>System memory</h4><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">System.Memory</td>
<td align="left">Available</td>
<td align="left">Available memory in bytes</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Total</td>
<td align="left">Total memory in bytes</td>
</tr>
<tr>
<td align="center"></td>
<td align="left">System.Swap</td>
<td align="left">Used</td>
<td align="left">Used swap bytes</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">Total</td>
<td align="left">Total swap in bytes</td>
</tr>
</tbody></table>
<h4 id="System-network"><a href="#System-network" class="headerlink" title="System network"></a>System network</h4><table>
<thead>
<tr>
<th align="center">Scope</th>
<th align="left">Infix</th>
<th align="left">Metrics</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>Job-&#x2F;TaskManager</strong></td>
<td align="left">System.Network.INTERFACE_NAME</td>
<td align="left">ReceiveRate</td>
<td align="left">Average receive rate in bytes per second</td>
</tr>
<tr>
<td align="center"></td>
<td align="left"></td>
<td align="left">SendRate</td>
<td align="left">Average send rate in bytes per second</td>
</tr>
</tbody></table>
<h3 id="使用REST-API获取TM系统性能指标"><a href="#使用REST-API获取TM系统性能指标" class="headerlink" title="使用REST API获取TM系统性能指标"></a>使用REST API获取TM系统性能指标</h3><p>举例部分API</p>
<h4 id="获取TM列表"><a href="#获取TM列表" class="headerlink" title="获取TM列表"></a>获取TM列表</h4><p><code>url</code>: <code>http://&lt;jobmanager&gt;:&lt;port&gt;/taskmanagers</code></p>
<h4 id="获取TM系统信息"><a href="#获取TM系统信息" class="headerlink" title="获取TM系统信息"></a>获取TM系统信息</h4><h5 id="CPU-1"><a href="#CPU-1" class="headerlink" title="CPU"></a>CPU</h5><p><code>url</code>: <code>http://&lt;jobmanager&gt;:&lt;port&gt;/taskmanagers/:taskmanagerid/metrics</code></p>
<p><code>params</code>: </p>
<ul>
<li><code>System.CPU.Usage</code>，这一指标显示可能与Top不同</li>
<li><code>System.CPU.Idle</code>，采集空闲指标</li>
</ul>
<h5 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h5><p><code>url</code>: <code>http://&lt;jobmanager&gt;:&lt;port&gt;/taskmanagers/:taskmanagerid/metrics</code></p>
<p><code>params</code>: </p>
<ul>
<li><code>System.Memory.Total</code>，字节数</li>
<li><code>System.Memory.Available</code>，采集空闲内存，字节数</li>
<li><code>System.Swap.Used</code>，使用Swap是否被使用，来考虑系统内存是否足够用，如果系统内存不足，则会使用Swap分区</li>
<li><code>System.Swap.Total</code>，</li>
</ul>
<h6 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h6><p><code>url</code>: <code>http://&lt;jobmanager&gt;:&lt;port&gt;/taskmanagers/:taskmanagerid/metrics</code></p>
<p><code>params</code>: </p>
<ul>
<li><code>System.Network.&lt;interface_name&gt;.ReceiveRate</code>，每秒字节数</li>
<li><code>System.Network.&lt;interface_name&gt;.SendRate</code>，发送字节数</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://halfcoke.github.io">HalfCoke</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://halfcoke.github.io/2020/c73cf02/">https://halfcoke.github.io/2020/c73cf02/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://halfcoke.github.io" target="_blank">CCCCCoke</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Flink/">Flink</a><a class="post-meta__tags" href="/tags/%E6%B5%81%E5%A4%84%E7%90%86/">流处理</a><a class="post-meta__tags" href="/tags/metrics/">metrics</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310130905.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/b1d7d7b5/"><img class="prev-cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">深度强化学习相关调研笔记</div></div></a></div><div class="next-post pull-right"><a href="/2020/8649918/"><img class="next-cover" src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202204102311990.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux Top 命令详解</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/26c0fffa/" title="Flink HiveSink源码分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310130718.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-04</div><div class="title">Flink HiveSink源码分析</div></div></a></div><div><a href="/2021/6a92d281/" title="Flink StreamingFileSink源码分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310131610.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-04</div><div class="title">Flink StreamingFileSink源码分析</div></div></a></div><div><a href="/2021/9367e715/" title="Flink 内存模型"><img class="cover" src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-04</div><div class="title">Flink 内存模型</div></div></a></div><div><a href="/2021/102c449e/" title="基于Debezium的Flink-MySQL-CDC源码分析"><img class="cover" src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202203310143241.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-07-04</div><div class="title">基于Debezium的Flink-MySQL-CDC源码分析</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/v2-bd05131cd8bea6dc03a408183fc37d22_b.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">HalfCoke</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">36</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">56</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">40</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/HalfCoke"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/HalfCoke" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">文章慢慢更新，乖，别急</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Flink-Metrics-REST-API%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Flink Metrics REST API使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Operator-Metrics%E9%87%87%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text">Operator Metrics采集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TaskManager-Metrics%E9%87%87%E9%9B%86"><span class="toc-number">1.2.</span> <span class="toc-text">TaskManager Metrics采集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM-CPU%E8%B4%9F%E8%BD%BD%E6%83%85%E5%86%B5"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">JVM CPU负载情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM-%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">JVM 内存使用情况</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JVM-%E5%86%85%E5%AD%98%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.0.2.1.</span> <span class="toc-text">JVM 内存类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#MemoryUsage"><span class="toc-number">1.2.0.2.2.</span> <span class="toc-text">MemoryUsage</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JVM%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%83%85%E5%86%B5"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">JVM垃圾回收情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#TM%E7%BD%91%E7%BB%9C%E6%83%85%E5%86%B5"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">TM网络情况</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Metrics-%E5%88%97%E8%A1%A8"><span class="toc-number">1.2.0.5.</span> <span class="toc-text">Metrics 列表</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#JVM-CPU%E6%8C%87%E6%A0%87"><span class="toc-number">1.2.0.5.1.</span> <span class="toc-text">JVM CPU指标</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JVM-Memory"><span class="toc-number">1.2.0.5.2.</span> <span class="toc-text">JVM Memory</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#GarbageCollection"><span class="toc-number">1.2.0.5.3.</span> <span class="toc-text">GarbageCollection</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8RestAPI%E8%8E%B7%E5%8F%96TM-JVM%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">1.2.0.6.</span> <span class="toc-text">使用RestAPI获取TM JVM性能指标</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU"><span class="toc-number">1.2.0.6.1.</span> <span class="toc-text">CPU</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#System-Metrics%E9%87%87%E9%9B%86"><span class="toc-number">1.3.</span> <span class="toc-text">System Metrics采集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.1.</span> <span class="toc-text">基本信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU%E4%BD%BF%E7%94%A8%E7%8E%87%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">CPU使用率获取方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BD%BF%E7%94%A8%E7%8E%87%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">内存使用率获取方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swap%E4%BA%A4%E6%8D%A2%E5%88%86%E5%8C%BA%E4%BD%BF%E7%94%A8%E7%8E%87%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">swap交换分区使用率获取方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%BD%BF%E7%94%A8%E6%83%85%E5%86%B5%E8%8E%B7%E5%8F%96%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">网络使用情况获取方式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEFlink"><span class="toc-number">1.3.2.</span> <span class="toc-text">配置Flink</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Metrics%E5%88%97%E8%A1%A8"><span class="toc-number">1.3.3.</span> <span class="toc-text">Metrics列表</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#System-CPU"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">System CPU</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#System-memory"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">System memory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#System-network"><span class="toc-number">1.3.3.3.</span> <span class="toc-text">System network</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8REST-API%E8%8E%B7%E5%8F%96TM%E7%B3%BB%E7%BB%9F%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87"><span class="toc-number">1.3.4.</span> <span class="toc-text">使用REST API获取TM系统性能指标</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96TM%E5%88%97%E8%A1%A8"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">获取TM列表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96TM%E7%B3%BB%E7%BB%9F%E4%BF%A1%E6%81%AF"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">获取TM系统信息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CPU-1"><span class="toc-number">1.3.4.2.1.</span> <span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Memory"><span class="toc-number">1.3.4.2.2.</span> <span class="toc-text">Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#Network"><span class="toc-number">1.3.4.2.2.1.</span> <span class="toc-text">Network</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/c0df81a5/" title="DeltaLake论文阅读笔记"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/202309291558033.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DeltaLake论文阅读笔记"/></a><div class="content"><a class="title" href="/2023/c0df81a5/" title="DeltaLake论文阅读笔记">DeltaLake论文阅读笔记</a><time datetime="2023-09-29T07:52:34.000Z" title="发表于 2023-09-29 15:52:34">2023-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/6b488705/" title="使用Nginx同时代理Web服务与Trojan（或其他TCP/UDP服务）"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/Nginx-Web-Server-Reverse-Proxy-Load-Balancer-Dengan-Performa-Tinggi.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="使用Nginx同时代理Web服务与Trojan（或其他TCP/UDP服务）"/></a><div class="content"><a class="title" href="/2023/6b488705/" title="使用Nginx同时代理Web服务与Trojan（或其他TCP/UDP服务）">使用Nginx同时代理Web服务与Trojan（或其他TCP/UDP服务）</a><time datetime="2023-04-02T07:58:29.000Z" title="发表于 2023-04-02 15:58:29">2023-04-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/a2e7677e/" title="白嫖系列-基于GitHub Action和国内公网服务器构建免费科学工具"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/spf.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="白嫖系列-基于GitHub Action和国内公网服务器构建免费科学工具"/></a><div class="content"><a class="title" href="/2022/a2e7677e/" title="白嫖系列-基于GitHub Action和国内公网服务器构建免费科学工具">白嫖系列-基于GitHub Action和国内公网服务器构建免费科学工具</a><time datetime="2022-10-30T08:01:55.000Z" title="发表于 2022-10-30 16:01:55">2022-10-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/50e64521/" title="K3S 安装及部署"><img src="https://cdn.jsdelivr.net/gh/HalfCoke/blog_img@master/img/image-20221021222858950.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="K3S 安装及部署"/></a><div class="content"><a class="title" href="/2022/50e64521/" title="K3S 安装及部署">K3S 安装及部署</a><time datetime="2022-10-21T14:22:19.000Z" title="发表于 2022-10-21 22:22:19">2022-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/b14aeca0/" title="利用Let's Encrypt获取免费的证书"><img src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用Let's Encrypt获取免费的证书"/></a><div class="content"><a class="title" href="/2022/b14aeca0/" title="利用Let's Encrypt获取免费的证书">利用Let's Encrypt获取免费的证书</a><time datetime="2022-10-03T06:26:40.000Z" title="发表于 2022-10-03 14:26:40">2022-10-03</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By HalfCoke</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: '0373d8209e264e713cc6',
      clientSecret: '5959db7d97f07e6f602d9ef98744530be3bea3fe',
      repo: 'HalfCoke.github.io',
      owner: 'HalfCoke',
      admin: ['HalfCoke'],
      id: '48921881dabdf27fa686c908f9b1d9b2',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>